<!-- landlord_Dashboard.html -->

{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container" style="max-width: 1100px; margin: auto; padding: 20px;">

    <h1>Welcome, {{ request.user.username }}</h1>
    <h2>Landlord Dashboard</h2>

    <!-- Summary Cards -->
    <!-- Total Properties, Available Properties, Add New Property, Browse Properties, My Properties -->
    <div style="display: flex; gap: 20px; margin: 20px 0;">
        <div style="flex:1; padding:20px; border:1px solid #ddd; border-radius:8px; text-align:center;">
            <h3>Total Properties</h3>
            <p style="font-size:24px; font-weight:bold;">{{ total_properties }}</p>
        </div>
        <div style="flex:1; padding:20px; border:1px solid #ddd; border-radius:8px; text-align:center;">
            <h3>Available Properties</h3>
            <p style="font-size:24px; font-weight:bold;">{{ available_properties }}</p>
        </div>

        <div style="flex:1; padding:20px; border:1px solid #ddd; border-radius:8px; text-align:center; display:flex; flex-direction:column; gap:10px;">
            
            <!-- Link to landlord_property_create.html-->
            <a href="{% url 'landlords:landlord_property_create' %}"
               style="padding:10px 20px; background:black; color:white; border-radius:4px; text-decoration:none;">
                + Add New Property
            </a>
            
            <!-- Link to browse_properties.html-->
            <a href="{% url 'landlords:landlords_browse' %}"
               style="padding:10px 20px; background:#555; color:white; border-radius:4px; text-decoration:none;">
                Browse Properties
            </a>
            
            <!-- Link to properties.html-->
            <a href="{% url 'landlords:landlord_property_list' %}"
               style="padding:10px 20px; background:#007BFF; color:white; border-radius:4px; text-decoration:none;">
                My Properties
            </a>

        </div>

    </div>
    

    <!-- Filter/Search Form -->
    <form method="get" style="margin: 15px 0; display:flex; flex-wrap: wrap; gap:10px;">
        <input type="text" name="q" placeholder="Search (house number, location)" 
               value="{{ request.GET.q }}" style="flex:2; padding:8px;">
        <select name="house_type" style="flex:1; padding:8px;">
            <option value="">House Type (Any)</option>
            <option value="single" {% if request.GET.house_type == "single" %}selected{% endif %}>Single Room</option>
            <option value="bedsitter" {% if request.GET.house_type == "bedsitter" %}selected{% endif %}>Bedsitter</option>
            <option value="1BR" {% if request.GET.house_type == "1BR" %}selected{% endif %}>One Bedroom</option>
            <option value="2BR" {% if request.GET.house_type == "2BR" %}selected{% endif %}>Two Bedroom</option>
            <option value="3BR" {% if request.GET.house_type == "3BR" %}selected{% endif %}>Three Bedroom</option>
            <option value="shared" {% if request.GET.house_type == "shared" %}selected{% endif %}>Shared Unit</option>
        </select>
        <select name="available" style="flex:1; padding:8px;">
            <option value="">Availability (Any)</option>
            <option value="true" {% if request.GET.available == "true" %}selected{% endif %}>Available</option>
            <option value="false" {% if request.GET.available == "false" %}selected{% endif %}>Not Available</option>
        </select>
        <button type="submit" style="padding:8px 14px; background:black; color:white; border-radius:4px;">Filter</button>
    </form>

    <!-- Properties Table -->
    <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="border-bottom:2px solid #ddd; text-align:left;">
                    <th style="padding:8px;">House Type</th>
                    <th style="padding:8px;">House Number</th>
                    <th style="padding:8px;">Rent (KES)</th>
                    <th style="padding:8px;">Location</th>
                    <th style="padding:8px;">Available</th>
                    <th style="padding:8px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for property in properties %}
                <tr id="property-row-{{ property.id }}" style="border-bottom:1px solid #eee;">
                    <td style="padding:8px;">{{ property.get_house_type_display }}</td>
                    <td style="padding:8px;">{{ property.house_number }}</td>
                    <td style="padding:8px;">{{ property.rent }}</td>
                    <td style="padding:8px;">{{ property.location }}</td>
                    <td style="padding:8px;">{% if property.available %}Yes{% else %}No{% endif %}</td>
                    <td style="padding:8px;">
                        <a href="{% url 'landlords:landlord_property_update' property.id %}" style="margin-right:5px; padding:4px 8px; background:#555; color:white; border-radius:4px; text-decoration:none;">Edit</a>
                        <button onclick="deleteProperty({{ property.id }})" 
                                style="padding:4px 8px; background:red; color:white; border-radius:4px; border:none; cursor:pointer;">
                            Delete
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="padding:8px; text-align:center;">You have no properties yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        {% if properties.has_other_pages %}
        <div style="margin-top: 15px; text-align:center;">
            {% if properties.has_previous %}
                <a href="?page={{ properties.previous_page_number }}" style="margin-right:10px;">« Previous</a>
            {% endif %}
        
            Page {{ properties.number }} of {{ properties.paginator.num_pages }}
        
            {% if properties.has_next %}
                <a href="?page={{ properties.next_page_number }}" style="margin-left:10px;">Next »</a>
            {% endif %}
        </div>
        {% endif %}
        
    </div>

</div>

<script>
// CSRF helper for AJAX
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteProperty(propertyId) {
    if (confirm('Are you sure you want to delete this property?')) {
        fetch(`/landlord/delete/${propertyId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Accept': 'application/json',
            },
        })
        .then(response => {
            if (response.ok) {
                // remove the deleted property row from the table
                document.querySelector(`#property-row-${propertyId}`).remove();
                alert('Property deleted successfully!');
            } else {
                alert('Failed to delete property.');
            }
        });
    }
}
</script>

{% endblock %}