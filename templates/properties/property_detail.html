{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container" style="max-width:900px; margin:auto; padding:20px;">

    <!-- IMAGE CAROUSEL -->
    <div class="property-carousel" 
         style="position:relative; width:100%; height:400px; overflow:hidden; border-radius:8px; margin-bottom:20px;"
         data-property-id="{{ property.id }}">
        {% if property.images.all %}
            <img id="property-img-{{ property.id }}" 
                 src="{{ property.images.all.0.image.url }}" 
                 style="width:100%; height:100%; object-fit:cover; border-radius:8px;">
            {% if property.images.count > 1 %}
                <button class="prev-btn" style="position:absolute; top:50%; left:10px; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:35px; height:35px;">‹</button>
                <button class="next-btn" style="position:absolute; top:50%; right:10px; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:35px; height:35px;">›</button>
            {% endif %}
        {% else %}
            <div style="width:100%; height:100%; background:#eee; display:flex; align-items:center; justify-content:center; border-radius:8px;">
                No Image
            </div>
        {% endif %}
    </div>

    <!-- PROPERTY DETAILS -->
    <div style="margin-bottom:20px;">
        <h2>{{ property.get_house_type_display }} - {{ property.house_number }}</h2>
        <p><strong>Location:</strong> {{ property.location }}, {{ property.town }}, {{ property.county }}</p>
        <p><strong>Rent:</strong> KES {{ property.rent }}</p>
        <p><strong>Availability:</strong> 
            {% if property.available %}
                <span style="color:green;">Yes</span>
            {% else %}
                <span style="color:red;">No</span>
            {% endif %}
        </p>
        <p><strong>Description:</strong> {{ property.description }}</p>
        {% if property.amenities %}
            <p><strong>Amenities:</strong> {{ property.amenities }}</p>
        {% endif %}
    </div>

    <!-- LANDLORD DETAILS -->
    <div style="border-top:1px solid #ddd; padding-top:15px; margin-bottom:20px;">
        <h3>Landlord Details</h3>
        <p><strong>Name:</strong> {{ property.landlord.user.get_full_name|default:property.landlord.user.username }}</p>
        <p><strong>Email:</strong> {{ property.landlord.user.email }}</p>
        {% if property.landlord.phone %}
            <p><strong>Phone:</strong> {{ property.landlord.phone }}</p>
        {% endif %}
        {% if property.landlord.social_media %}
            <p><strong>Social Media:</strong> <a href="{{ property.landlord.social_media }}" target="_blank">{{ property.landlord.social_media }}</a></p>
        {% endif %}
    </div>

    <!-- ACTIONS -->
    <div style="display:flex; gap:10px; margin-bottom:30px;">
        <!-- Favorite / Unfavorite -->
        <form method="post" action="{% url 'tenants:favorite_property' property.id %}" onsubmit="return confirm('Are you sure you want to perform this action?');">
            {% csrf_token %}
            {% if user.is_authenticated and property.id in favorite_property_ids %}
                <button type="submit" style="background:red; color:white; padding:8px 14px; border:none; border-radius:4px;">♥ Unfavorite</button>
            {% else %}
                <button type="submit" style="background:#555; color:white; padding:8px 14px; border:none; border-radius:4px;">♡ Favorite</button>
            {% endif %}
        </form>

        <!-- Request Viewing / Contact -->
        <a href="{% url 'tenants:request_viewing' property.id %}" 
           style="background:#007bff; color:white; padding:8px 14px; border-radius:4px; text-decoration:none; display:flex; align-items:center; justify-content:center;">
           Request Viewing
        </a>
    </div>
</div>

<!-- IMAGE CAROUSEL SCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const propertyId = "{{ property.id }}";
    const imgs = [
        {% for img in property.images.all %}
            "{{ img.image.url }}",
        {% endfor %}
    ];
    let index = 0;

    function showImage(i) {
        document.getElementById(`property-img-${propertyId}`).src = imgs[i];
    }

    const carousel = document.querySelector('.property-carousel');
    const prevBtn = carousel.querySelector('.prev-btn');
    const nextBtn = carousel.querySelector('.next-btn');

    if (prevBtn) prevBtn.addEventListener('click', () => {
        index = (index - 1 + imgs.length) % imgs.length;
        showImage(index);
    });
    if (nextBtn) nextBtn.addEventListener('click', () => {
        index = (index + 1) % imgs.length;
        showImage(index);
    });

    // Optional swipe for mobile
    let startX = 0;
    carousel.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
    carousel.addEventListener('touchend', e => {
        const diff = e.changedTouches[0].clientX - startX;
        if (Math.abs(diff) > 30) {
            index = (diff < 0 ? index + 1 : index - 1 + imgs.length) % imgs.length;
            showImage(index);
        }
    });
});
</script>
{% endblock %}
