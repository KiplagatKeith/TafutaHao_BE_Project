<!-- templates/properties/property_list.html -->
 
{% extends 'base.html' %}

{% block content %}
<div class="container" style="max-width: 1100px; margin: auto; padding: 20px;">
    <!-- Top bar -->
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Browse Available Properties</h1>
        <!-- Circular account icon -->
        <a href="#" onclick="document.getElementById('account-menu').classList.toggle('hidden');" 
           style="display:inline-block; width:40px; height:40px; border-radius:50%; background:#333; color:white; text-align:center; line-height:40px; font-weight:bold; font-size:20px; text-decoration:none;">
            A
        </a>
        <!-- Account dropdown -->
        <div id="account-menu" class="hidden" style="position:absolute; right:20px; top:70px; background:white; border:1px solid #ddd; border-radius:6px; padding:10px;">
            {% if user.is_authenticated %}
                <p>{{ user.username }}</p>
                <a href="{% url 'settings' %}">Settings</a><br>
                <a href="{% url 'accounts:logout' %}">Logout</a>
            {% else %}
                <a href="{% url 'accounts:login' %}">Login</a><br>
                <a href="{% url 'accounts:signup' %}">Signup</a>
            {% endif %}
        </div>
    </div>

    <!-- Filter Form -->
    <form method="get" style="margin-bottom: 15px; display:flex; gap:10px; flex-wrap: wrap;">
        <input type="text" name="q" placeholder="Search description/location" value="{{ search_query }}" style="flex:2; padding:8px;">
        <input type="number" name="min_rent" placeholder="Min Rent" value="{{ min_rent }}" style="flex:1; padding:8px;">
        <input type="number" name="max_rent" placeholder="Max Rent" value="{{ max_rent }}" style="flex:1; padding:8px;">
        
        <select name="county" style="flex:1; padding:8px;">
            <option value="">County (Any)</option>
            {% for c in counties %}
                <option value="{{ c }}" {% if c == county %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
    
        <select name="town" style="flex:1; padding:8px;">
            <option value="">Town/City (Any)</option>
            {% for t in towns %}
                <option value="{{ t }}" {% if t == town %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
        </select>
    
        <input type="text" name="location" placeholder="Location" value="{{ request.GET.location }}" style="flex:1; padding:8px;">
    
        <select name="house_type" style="flex:1; padding:8px;">
            <option value="">House Type (Any)</option>
            <option value="single" {% if house_type == "single" %}selected{% endif %}>Single Room</option>
            <option value="bedsitter" {% if house_type == "bedsitter" %}selected{% endif %}>Bedsitter</option>
            <option value="1BR" {% if house_type == "1BR" %}selected{% endif %}>One Bedroom</option>
            <option value="2BR" {% if house_type == "2BR" %}selected{% endif %}>Two Bedroom</option>
            <option value="3BR" {% if house_type == "3BR" %}selected{% endif %}>Three Bedroom</option>
            <option value="shared" {% if house_type == "shared" %}selected{% endif %}>Shared Unit</option>
        </select>
    
        <button type="submit" style="padding:8px 14px; background:black; color:white; border-radius:4px;">Filter</button>
    </form>


    {% if properties %}
        {% for property in properties %}
        <div style="border:1px solid #ddd; padding:15px; border-radius:8px; margin-bottom:10px;">
            <h3>{{ property.get_house_type_display }} - {{ property.house_number }}</h3>
            <p>{{ property.description|truncatewords:20 }}</p>
            <p>Location: {{ property.location }}</p>
            <p>Rent: KES {{ property.rent }}</p>
            <p>Available: {{ property.available }}</p>
            <a href="{% url 'properties:property_detail' property.id %}" style="padding:6px 10px; background:#555; color:white; border-radius:4px;">View Details</a>
        </div>
        {% endfor %}
    {% else %}
        <p>No properties match your search.</p>
    {% endif %}

    <!-- Pagination -->
    {% if is_paginated %}
    <div style="text-align:center; margin-top:20px;">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}&min_rent={{ request.GET.min_rent }}&max_rent={{ request.GET.max_rent }}&location={{ request.GET.location }}&house_type={{ request.GET.house_type }}">« Previous</a>
        {% endif %}
        <span style="margin:0 10px;">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}&min_rent={{ request.GET.min_rent }}&max_rent={{ request.GET.max_rent }}&location={{ request.GET.location }}&house_type={{ request.GET.house_type }}">Next »</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const countySelect = document.querySelector('select[name="county"]');
    const townSelect = document.querySelector('select[name="town"]');

    const ajaxTownsUrl = "{% url 'properties:get_towns_by_county' %}";

    countySelect.addEventListener('change', function() {
        const selectedCounty = this.value.trim();

        // Reset town dropdown
        townSelect.innerHTML = '<option value="">Town/City (Any)</option>';

        if (!selectedCounty) return;

        fetch(`${ajaxTownsUrl}?county=${encodeURIComponent(selectedCounty)}`)
            .then(res => res.json())
            .then(data => {
                if (data.towns.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No towns found';
                    townSelect.appendChild(option);
                } else {
                    data.towns.forEach(town => {
                        const option = document.createElement('option');
                        option.value = town;
                        option.textContent = town;
                        townSelect.appendChild(option);
                    });
                }
            })
            .catch(err => console.error('AJAX error:', err));
    });
});
</script>

<style>
.hidden { display: none; }
</style>
{% endblock %}

