<!-- templates/tenants/browse_properties.html -->
 
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container" style="max-width: 1100px; margin:auto; padding:20px;">
    <h2>Browse Available Properties</h2>

    <!-- Search and Filter Form -->
    <form method="get" class="filter-form" style="margin:15px 0; display:flex; flex-wrap:wrap; gap:10px;">
        <input type="text" name="q" placeholder="Search (description)" value="{{ search_query }}" style="flex:2; padding:8px;">
        <input type="number" name="min_rent" placeholder="Min Rent" value="{{ min_rent }}" style="flex:1; padding:8px;">
        <input type="number" name="max_rent" placeholder="Max Rent" value="{{ max_rent }}" style="flex:1; padding:8px;">

        <select name="county" id="county-select" style="flex:1; padding:8px;">
            <option value="">County (Any)</option>
            {% for c in counties %}
                <option value="{{ c }}" {% if c == county %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>

        <select name="town" id="town-select" style="flex:1; padding:8px;">
            <option value="">Town/City (Any)</option>
            {% for t in towns %}
                <option value="{{ t }}" {% if t == town %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
        </select>

        <input type="text" name="location" placeholder="Location" value="{{ location }}" style="flex:1; padding:8px;">

        <select name="house_type" style="flex:1; padding:8px;">
            <option value="">House Type (Any)</option>
            <option value="single" {% if house_type == "single" %}selected{% endif %}>Single Room</option>
            <option value="bedsitter" {% if house_type == "bedsitter" %}selected{% endif %}>Bedsitter</option>
            <option value="1BR" {% if house_type == "1BR" %}selected{% endif %}>One Bedroom</option>
            <option value="2BR" {% if house_type == "2BR" %}selected{% endif %}>Two Bedroom</option>
            <option value="3BR" {% if house_type == "3BR" %}selected{% endif %}>Three Bedroom</option>
            <option value="shared" {% if house_type == "shared" %}selected{% endif %}>Shared Unit</option>
        </select>

        <!-- Submit Button -->
        <button type="submit" 
                style="padding:8px 14px; background:black; color:white; border-radius:4px;">
            Filter
        </button>

        <!-- Reset Button -->
        <a href="{% url 'tenants:browse_properties' %}"
           style="padding:8px 14px; background:gray; color:white; border-radius:4px;
                  text-decoration:none; margin-left:5px;">
           Reset
        </a>

    </form>

    <!-- Property Cards -->
    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap:15px; margin-top:25px;">
        {% for property in properties %}
        <div style="border:1px solid #ddd; padding:15px; border-radius:8px; transition: transform 0.2s;" 
             onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">

            <!-- Image Carousel -->
            <div class="property-carousel" 
                 style="position:relative; width:100%; height:180px; overflow:hidden; border-radius:6px;"
                 data-property-id="{{ property.id }}">
                {% if property.images.all %}
                    <img id="property-img-{{ property.id }}" 
                         src="{{ property.images.all.0.image.url }}" 
                         style="width:100%; height:100%; object-fit:cover; cursor:pointer;" 
                         class="lightbox-trigger" 
                         data-property-id="{{ property.id }}">
                    {% if property.images.count > 1 %}
                        <button class="prev-btn" style="position:absolute; top:50%; left:5px; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:30px; height:30px;">‹</button>
                        <button class="next-btn" style="position:absolute; top:50%; right:5px; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:30px; height:30px;">›</button>
                    {% endif %}
                {% else %}
                    <div style="width:100%; height:100%; background:#eee; display:flex; align-items:center; justify-content:center;">
                        <span>No Image</span>
                    </div>
                {% endif %}
            </div>

            <!-- Property Info -->
            <h4 style="margin-top:10px;">{{ property.get_house_type_display }} - {{ property.house_number }}</h4>
            <p><strong>Rent:</strong> KES {{ property.rent }}</p>
            <p><strong>County:</strong> {{ property.county }}</p>
            <p><strong>Town/City:</strong> {{ property.town }}</p>
            <p><strong>Location:</strong> {{ property.location }}</p>
            <p style="font-size:14px; opacity:0.9;">{{ property.description|truncatewords:20 }}</p>

            <!-- Favorite & Unfavorite Button -->
            <form method="post" 
                  action="{% if user.is_authenticated %}{% url 'tenants:favorite_property' property.id %}{% else %}{% url 'accounts:signup' %}?next={{ request.path }}{% endif %}" 
                  class="favorite-form">
                {% csrf_token %}
                {% if user.is_authenticated and property.id in favorite_property_ids %}
                    <button type="submit" data-action="unfavorite" style="background:red; color:white; padding:6px 10px; border:none; border-radius:4px;">
                        ♥ Unfavorite
                    </button>
                {% else %}
                    <button type="submit" data-action="favorite" style="background:#555; color:white; padding:6px 10px; border:none; border-radius:4px;">
                        ♡ Favorite
                    </button>
                {% endif %}
            </form>


            <!-- View Details Button -->
            <a href="{% url 'properties:property_detail' property.id %}" 
               class="view-details-btn"
               style="display:block; padding:6px 10px; background:#6c757d; color:white; text-align:center; border-radius:4px; text-decoration:none; margin-top:5px;">
               View Details
            </a>


        </div>
        {% empty %}
            <p>No properties match your search.</p>
        {% endfor %}
    </div>


    <!-- Pagination -->
    {% if is_paginated %}
    <div style="text-align:center; margin-top:20px;">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&min_rent={{ min_rent }}&max_rent={{ max_rent }}&county={{ county }}&town={{ town }}&location={{ location }}&house_type={{ house_type }}">« Previous</a>
        {% endif %}
        <span style="margin:0 10px;">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&min_rent={{ min_rent }}&max_rent={{ max_rent }}&county={{ county }}&town={{ town }}&location={{ location }}&house_type={{ house_type }}">Next »</a>
        {% endif %}
    </div>
    {% endif %}

    <!-- Confirmation Modal -->
    <div id="confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999;">
        <div style="background:white; padding:20px; border-radius:8px; max-width:400px; width:90%; text-align:center;">
            <p id="confirm-message" style="margin-bottom:20px;">Are you sure?</p>
            <button id="confirm-yes" style="padding:6px 12px; margin-right:10px; background:#007bff; color:white; border:none; border-radius:4px;">Yes</button>
            <button id="confirm-no" style="padding:6px 12px; background:#dc3545; color:white; border:none; border-radius:4px;">No</button>
        </div>
    </div>

    <!-- LOGIN/SIGNUP PROMPT MODAL -->
    <div id="login-signup-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
         background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:10000;">
        <div style="background:white; padding:20px; border-radius:8px; max-width:400px; width:90%; text-align:center;">
            <p>You need to login or signup to perform this action.</p>
            <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
                <button id="modal-login" style="padding:8px 14px; border:none; border-radius:4px; background:#007bff; color:white;">Login</button>
                <button id="modal-signup" style="padding:8px 14px; border:none; border-radius:4px; background:#28a745; color:white;">Signup</button>
                <button id="modal-cancel" style="padding:8px 14px; border:none; border-radius:4px; background:#6c757d; color:white;">Cancel</button>
            </div>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const countySelect = document.getElementById('county-select');
    const townSelect = document.getElementById('town-select');
    const ajaxTownsUrl = "{% url 'properties:get_towns_by_county' %}";

    // ===== County & Town dynamic dropdown =====
    countySelect.addEventListener('change', function() {
        const selectedCounty = this.value.trim();
        townSelect.innerHTML = '<option value="">Town/City (Any)</option>';
        if (!selectedCounty) return;

        fetch(`${ajaxTownsUrl}?county=${encodeURIComponent(selectedCounty)}`)
            .then(res => res.json())
            .then(data => {
                data.towns.forEach(town => {
                    const option = document.createElement('option');
                    option.value = town;
                    option.textContent = town;
                    townSelect.appendChild(option);
                });
            });
    });

    // ===== Property images carousel =====
    const propertyImages = {
        {% for property in properties %}
            {{ property.id }}: [
                {% for img in property.images.all %}
                    "{{ img.image.url }}",
                {% endfor %}
            ],
        {% endfor %}
    };
    const propertyImageIndex = {};

    function showImage(propertyId, index) {
        const imgs = propertyImages[propertyId];
        if (!imgs || imgs.length === 0) return;
        document.getElementById(`property-img-${propertyId}`).src = imgs[index];
        propertyImageIndex[propertyId] = index;
    }

    function nextImage(propertyId) {
        const imgs = propertyImages[propertyId];
        if (!imgs || imgs.length <= 1) return;
        let idx = (propertyImageIndex[propertyId] || 0) + 1;
        if (idx >= imgs.length) idx = 0;
        showImage(propertyId, idx);
    }

    function prevImage(propertyId) {
        const imgs = propertyImages[propertyId];
        if (!imgs || imgs.length <= 1) return;
        let idx = (propertyImageIndex[propertyId] || 0) - 1;
        if (idx < 0) idx = imgs.length - 1;
        showImage(propertyId, idx);
    }

    document.querySelectorAll('.property-carousel').forEach(carousel => {
        const propertyId = carousel.dataset.propertyId;
        const prevBtn = carousel.querySelector('.prev-btn');
        const nextBtn = carousel.querySelector('.next-btn');
        if (prevBtn) prevBtn.addEventListener('click', () => prevImage(propertyId));
        if (nextBtn) nextBtn.addEventListener('click', () => nextImage(propertyId));

        // Touch events for mobile swipe
        let startX = 0;
        carousel.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
        carousel.addEventListener('touchend', e => {
            const diff = e.changedTouches[0].clientX - startX;
            if (Math.abs(diff) > 30) { if (diff < 0) nextImage(propertyId); else prevImage(propertyId); }
        });
    });

    // ===== Favorite / Unfavorite confirmation modal =====
    const modal = document.getElementById('confirm-modal');
    const message = document.getElementById('confirm-message');
    const yesBtn = document.getElementById('confirm-yes');
    const noBtn = document.getElementById('confirm-no');
    let currentForm = null;

    document.querySelectorAll('.favorite-form button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            currentForm = this.closest('form');
            const action = this.dataset.action;
            message.textContent = action === 'favorite'
                ? 'Are you sure you want to add this property to your favorites?'
                : 'Are you sure you want to remove this property from your favorites?';
            modal.style.display = 'flex';
        });
    });

    yesBtn.addEventListener('click', function() { if(currentForm) currentForm.submit(); modal.style.display='none'; });
    noBtn.addEventListener('click', function() { modal.style.display='none'; currentForm=null; });
    modal.addEventListener('click', e => { if(e.target===modal){modal.style.display='none'; currentForm=null;} });

    // ===== Lightbox =====
    // Create modal elements dynamically
    const lightboxModal = document.createElement('div');
    lightboxModal.id = 'lightbox-modal';
    lightboxModal.style.cssText = 'display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;z-index:10000;';
    lightboxModal.innerHTML = `
        <span id="lightbox-close" style="position:absolute;top:20px;right:30px;font-size:40px;color:white;cursor:pointer;">&times;</span>
        <img id="lightbox-img" src="" style="max-width:90%; max-height:90%; cursor:grab;">
        <button id="lightbox-prev" style="position:absolute;top:50%;left:20px;font-size:40px;color:white;background:none;border:none;cursor:pointer;">‹</button>
        <button id="lightbox-next" style="position:absolute;top:50%;right:20px;font-size:40px;color:white;background:none;border:none;cursor:pointer;">›</button>
    `;
    document.body.appendChild(lightboxModal);

    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxClose = document.getElementById('lightbox-close');
    const lightboxNext = document.getElementById('lightbox-next');
    const lightboxPrev = document.getElementById('lightbox-prev');

    let currentPropertyId = null;
    let currentImageIndex = 0;

    document.querySelectorAll('.lightbox-trigger').forEach(img => {
        img.addEventListener('click', function() {
            currentPropertyId = this.dataset.propertyId;
            currentImageIndex = propertyImageIndex[currentPropertyId] || 0;
            lightboxImg.src = propertyImages[currentPropertyId][currentImageIndex];
            lightboxImg.style.transform = 'scale(1)';
            lightboxImg.style.left='0px';
            lightboxImg.style.top='0px';
            lightboxModal.style.display = 'flex';
        });
    });

    lightboxClose.addEventListener('click', ()=>lightboxModal.style.display='none');

    lightboxNext.addEventListener('click', ()=>{
        if(!currentPropertyId) return;
        const imgs = propertyImages[currentPropertyId];
        currentImageIndex=(currentImageIndex+1)%imgs.length;
        lightboxImg.src=imgs[currentImageIndex];
        lightboxImg.style.transform='scale(1)'; lightboxImg.style.left='0px'; lightboxImg.style.top='0px';
    });

    lightboxPrev.addEventListener('click', ()=>{
        if(!currentPropertyId) return;
        const imgs = propertyImages[currentPropertyId];
        currentImageIndex=(currentImageIndex-1+imgs.length)%imgs.length;
        lightboxImg.src=imgs[currentImageIndex];
        lightboxImg.style.transform='scale(1)'; lightboxImg.style.left='0px'; lightboxImg.style.top='0px';
    });

    lightboxModal.addEventListener('click', e=>{if(e.target===lightboxModal) lightboxModal.style.display='none';});

    // Zoom with wheel
    lightboxImg.addEventListener('wheel', e=>{
        e.preventDefault();
        let scale = lightboxImg.style.transform.replace(/[^0-9.]/g,'') || 1;
        scale=parseFloat(scale);
        if(e.deltaY<0) scale+=0.1; else scale=Math.max(1,scale-0.1);
        lightboxImg.style.transform=`scale(${scale})`;
    });

    // Drag image
    let isDragging=false, startX, startY, initialX=0, initialY=0;
    lightboxImg.addEventListener('mousedown', e=>{
        isDragging=true; startX=e.clientX; startY=e.clientY;
        initialX=parseInt(lightboxImg.style.left)||0; initialY=parseInt(lightboxImg.style.top)||0;
    });
    document.addEventListener('mouseup', ()=>{isDragging=false;});
    document.addEventListener('mousemove', e=>{
        if(!isDragging) return;
        const dx=e.clientX-startX, dy=e.clientY-startY;
        lightboxImg.style.position='relative';
        lightboxImg.style.left=(initialX+dx)+'px';
        lightboxImg.style.top=(initialY+dy)+'px';
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
    if (isAuthenticated) return; // Do nothing for logged-in users

    const modal = document.getElementById('login-signup-modal');
    const loginBtn = document.getElementById('modal-login');
    const signupBtn = document.getElementById('modal-signup');
    const cancelBtn = document.getElementById('modal-cancel');

    // Attach click events for all favorite forms
    document.querySelectorAll('.favorite-form button').forEach(btn => {
        btn.addEventListener('click', function(e){
            e.preventDefault();
            modal.style.display = 'flex';
        });
    });

    // Attach click events for all "View Details" links
    document.querySelectorAll('.view-details-btn').forEach(link => {
        link.addEventListener('click', function(e){
            e.preventDefault();
            modal.style.display = 'flex';
        });
    });

    // Modal button actions
    loginBtn.addEventListener('click', () => {
        window.location.href = "{% url 'accounts:login' %}?next={{ request.path }}";
    });
    signupBtn.addEventListener('click', () => {
        window.location.href = "{% url 'accounts:signup' %}?next={{ request.path }}";
    });
    cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    // Close modal if click outside inner box
    modal.addEventListener('click', e => {
        if (e.target === modal) modal.style.display = 'none';
    });
});
</script>

{% endblock %}