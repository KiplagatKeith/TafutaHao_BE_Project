{% extends 'base.html' %}
{% load static %}

{% block content %}
<div style="max-width:1000px; margin:auto; padding:30px; font-family:Arial, sans-serif;">

    <!-- PROFILE HEADER -->
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
        <h1 style="font-size:28px; color:#333;">{{ tenant_profile.user.username }}'s Profile</h1>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <a href="{% url 'tenants:tenant_account_edit' %}"
               style="padding:10px 16px; background:#007bff; color:white; text-decoration:none; border-radius:6px; font-weight:bold; transition:0.3s;">
                Edit Account
            </a>

            <a href="{% url 'tenants:tenant_profile_delete' %}"
               style="padding:10px 16px; background:#dc3545; color:white; text-decoration:none; border-radius:6px; font-weight:bold; transition:0.3s;">
                Delete Profile
            </a>
        </div>
    </div>

    <hr style="margin:25px 0; border:1px solid #eee;">

    <!-- ACCOUNT DETAILS CARD -->
    <div style="background:#f9f9f9; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:30px;">
        <h2 style="font-size:22px; color:#555; margin-bottom:15px;">Account Details</h2>

        <p><strong>Username:</strong> <span style="color:#333;">{{ tenant_profile.user.username }}</span></p>
        <p><strong>Email:</strong> <span style="color:#333;">{{ tenant_profile.user.email }}</span></p>
        {% if tenant_profile.user.phone_number %}
            <p><strong>Phone:</strong> <span style="color:#333;">{{ tenant_profile.user.phone_number }}</span></p>
        {% endif %}
    </div>

    <!-- FAVORITE PROPERTIES -->
    <h2 style="font-size:22px; color:#555; margin-bottom:15px;">Favorite Properties</h2>

    <div class="favorite-properties"
         style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:20px;">
        
        {% for fav in favorite_properties %}
            <div class="property-card"
                 style="border:1px solid #ddd; border-radius:10px; overflow:hidden; background:white; box-shadow:0 3px 8px rgba(0,0,0,0.1); transition:transform 0.2s; cursor:pointer;"
                 onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">

                <!-- Image Carousel -->
                <div class="property-carousel" style="position:relative; width:100%; height:180px; overflow:hidden; border-radius:6px;" data-property-id="{{ fav.property.id }}">
                    {% if fav.property.images.all %}
                        <img id="property-img-{{ fav.property.id }}"
                             src="{{ fav.property.images.all.0.image.url }}"
                             style="width:100%; height:100%; object-fit:cover;"
                             class="lightbox-trigger"
                             data-property-id="{{ fav.property.id }}">
                        {% if fav.property.images.count > 1 %}
                            <button class="prev-btn" style="position:absolute; top:50%; left:5px; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:30px; height:30px;">‹</button>
                            <button class="next-btn" style="position:absolute; top:50%; right:5px; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:30px; height:30px;">›</button>
                        {% endif %}
                    {% else %}
                        <div style="width:100%; height:100%; background:#eee; display:flex; align-items:center; justify-content:center;">
                            <span>No Image</span>
                        </div>
                    {% endif %}
                </div>

                <!-- Property Info -->
                <div style="padding:15px;">
                    <h3 style="font-size:18px; color:#222; margin-bottom:8px;">
                        {{ fav.property.get_house_type_display }} - {{ fav.property.house_number }}
                    </h3>

                    <p style="font-size:14px; color:#666; margin-bottom:10px;">
                        {{ fav.property.description|truncatewords:18 }}
                    </p>

                    <p style="font-size:14px; color:#444; margin-bottom:10px;">
                        <strong>Location:</strong> {{ fav.property.location }}<br>
                        <strong>Rent:</strong> KES {{ fav.property.rent }}
                    </p>

                    <!-- Buttons -->
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <!-- Remove Favorite -->
                        <form method="post" action="{% url 'tenants:favorite_property' fav.property.id %}" style="flex:1;">
                            {% csrf_token %}
                            <button type="submit"
                                    style="width:100%; padding:8px 0; background:#ff4d4f; color:white; border:none; border-radius:6px; font-weight:bold; transition:0.3s;">
                                Remove Favorite
                            </button>
                        </form>

                        <!-- View Details -->
                        <a href="{% url 'properties:property_detail' fav.property.id %}" 
                           class="view-details-btn"
                           style="flex:1; text-align:center; padding:8px 0; background:#6c757d; color:white; border-radius:6px; text-decoration:none; font-weight:bold; transition:0.3s;">
                           View Details
                        </a>
                    </div>
                </div>
            </div>
        {% empty %}
            <p style="color:#777;">You have no favorite properties yet.</p>
        {% endfor %}
    </div>

</div>

<!-- Carousel & Lightbox JS -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const propertyImages = {
        {% for fav in favorite_properties %}
            {{ fav.property.id }}: [
                {% for img in fav.property.images.all %}
                    "{{ img.image.url }}",
                {% endfor %}
            ],
        {% endfor %}
    };
    const propertyImageIndex = {};

    function showImage(propertyId, index) {
        const imgs = propertyImages[propertyId];
        if (!imgs || imgs.length === 0) return;
        document.getElementById(`property-img-${propertyId}`).src = imgs[index];
        propertyImageIndex[propertyId] = index;
    }

    function nextImage(propertyId) {
        const imgs = propertyImages[propertyId];
        if (!imgs || imgs.length <= 1) return;
        let idx = (propertyImageIndex[propertyId] || 0) + 1;
        if (idx >= imgs.length) idx = 0;
        showImage(propertyId, idx);
    }

    function prevImage(propertyId) {
        const imgs = propertyImages[propertyId];
        if (!imgs || imgs.length <= 1) return;
        let idx = (propertyImageIndex[propertyId] || 0) - 1;
        if (idx < 0) idx = imgs.length - 1;
        showImage(propertyId, idx);
    }

    document.querySelectorAll('.property-carousel').forEach(carousel => {
        const propertyId = carousel.dataset.propertyId;
        const prevBtn = carousel.querySelector('.prev-btn');
        const nextBtn = carousel.querySelector('.next-btn');
        if (prevBtn) prevBtn.addEventListener('click', () => prevImage(propertyId));
        if (nextBtn) nextBtn.addEventListener('click', () => nextImage(propertyId));
    });

    // Lightbox for all images
    const lightboxModal = document.createElement('div');
    lightboxModal.id = 'lightbox-modal';
    lightboxModal.style.cssText = 'display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;z-index:10000;';
    lightboxModal.innerHTML = `
        <span id="lightbox-close" style="position:absolute;top:20px;right:30px;font-size:40px;color:white;cursor:pointer;">&times;</span>
        <img id="lightbox-img" src="" style="max-width:90%; max-height:90%; cursor:grab;">
        <button id="lightbox-prev" style="position:absolute;top:50%;left:20px;font-size:40px;color:white;background:none;border:none;cursor:pointer;">‹</button>
        <button id="lightbox-next" style="position:absolute;top:50%;right:20px;font-size:40px;color:white;background:none;border:none;cursor:pointer;">›</button>
    `;
    document.body.appendChild(lightboxModal);

    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxClose = document.getElementById('lightbox-close');
    const lightboxNext = document.getElementById('lightbox-next');
    const lightboxPrev = document.getElementById('lightbox-prev');

    let currentPropertyId = null;
    let currentImageIndex = 0;

    document.querySelectorAll('.lightbox-trigger').forEach(img => {
        img.addEventListener('click', function() {
            currentPropertyId = this.dataset.propertyId;
            currentImageIndex = propertyImageIndex[currentPropertyId] || 0;
            lightboxImg.src = propertyImages[currentPropertyId][currentImageIndex];
            lightboxImg.style.transform = 'scale(1)';
            lightboxImg.style.left='0px';
            lightboxImg.style.top='0px';
            lightboxModal.style.display = 'flex';
        });
    });

    lightboxClose.addEventListener('click', ()=>lightboxModal.style.display='none');
    lightboxNext.addEventListener('click', ()=>{
        if(!currentPropertyId) return;
        const imgs = propertyImages[currentPropertyId];
        currentImageIndex=(currentImageIndex+1)%imgs.length;
        lightboxImg.src=imgs[currentImageIndex];
        lightboxImg.style.transform='scale(1)';
        lightboxImg.style.left='0px'; lightboxImg.style.top='0px';
    });
    lightboxPrev.addEventListener('click', ()=>{
        if(!currentPropertyId) return;
        const imgs = propertyImages[currentPropertyId];
        currentImageIndex=(currentImageIndex-1+imgs.length)%imgs.length;
        lightboxImg.src=imgs[currentImageIndex];
        lightboxImg.style.transform='scale(1)';
        lightboxImg.style.left='0px'; lightboxImg.style.top='0px';
    });
    lightboxModal.addEventListener('click', e=>{if(e.target===lightboxModal) lightboxModal.style.display='none';});

});
</script>

{% endblock %}
